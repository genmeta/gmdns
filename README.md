# GMDNS

GMDNS æ˜¯ä¸€ä¸ªåŸºäº Rust å¼€å‘çš„é«˜æ€§èƒ½ mDNS (Multicast DNS) åè®®åº“ï¼Œä¸“é—¨ä¸º P2P ç½‘ç»œå‘ç°å’Œç©¿é€åœºæ™¯è®¾è®¡ã€‚å®ƒä¸ä»…æ”¯æŒæ ‡å‡†çš„ RFC 6762 åè®®ï¼Œè¿˜é€šè¿‡è‡ªå®šä¹‰èµ„æºè®°å½•æ‰©å±•äº†ç«¯ç‚¹ï¼ˆEndpointï¼‰å‘ç°èƒ½åŠ›ï¼Œæ”¯æŒç›´è¿å’Œä¸­ç»§åœ°å€çš„å‘å¸ƒä¸éªŒè¯ã€‚

## ğŸŒŸ æ ¸å¿ƒç‰¹æ€§

- **æ ‡å‡†å…¼å®¹**ï¼šæ”¯æŒæ ‡å‡† DNS æŠ¥æ–‡æ ¼å¼åŠ mDNS ç»„æ’­å‘ç°ã€‚
- **P2P å¢å¼º**ï¼šè‡ªå®šä¹‰ `E` è®°å½•ï¼Œæ”¯æŒ IPv4/IPv6 çš„ç›´è¿ä¸ä¸­ç»§åœ°å€ã€‚
- **å®‰å…¨éªŒè¯**ï¼šå†…ç½® Ed25519 ç­‰ç­¾åæ–¹æ¡ˆï¼Œç¡®ä¿ç«¯ç‚¹æ•°æ®çš„çœŸå®æ€§ä¸å®Œæ•´æ€§ã€‚
- **é«˜æ€§èƒ½è§£æ**ï¼šåŸºäº `nom` é›¶æ‹·è´è§£ææ¡†æ¶ï¼Œæä¾›æé€Ÿçš„æŠ¥æ–‡å¤„ç†èƒ½åŠ›ã€‚
- **å¼‚æ­¥é©±åŠ¨**ï¼šå®Œå…¨é€‚é… `tokio` å¼‚æ­¥è¿è¡Œæ—¶ï¼Œé€‚ç”¨äºé«˜å¹¶å‘ç½‘ç»œç¯å¢ƒã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

åœ¨ `Cargo.toml` ä¸­å¼•ç”¨ï¼š

```toml
[dependencies]
gmdns = { path = "../gmdns" }
```

### ç®€å•å‘ç°ç¤ºä¾‹

```rust
use gmdns::mdns::Mdns;
use futures::StreamExt;

#[tokio::main]
async fn main() -> Result<(), std::io::Error> {
    // åˆ›å»º mDNS å®ä¾‹
    let mdns = Mdns::new("_genmeta.local", "127.0.0.1".parse().unwrap(), "lo0")?;
    
    // ç›‘å¬å‘ç°æµ
    let mut stream = mdns.discover();
    while let Some((addr, packet)) = stream.next().await {
        println!("å‘ç°æ¥è‡ª {} çš„æŠ¥æ–‡: {:?}", addr, packet);
    }
    Ok(())
}
```

---

## ğŸ“– åè®®è§„èŒƒ (Protocol Specification)

### 1. æ•´ä½“æŠ¥æ–‡ç»“æ„ (Packet Layout)

DNS æŠ¥æ–‡ç”±å›ºå®šå¤´éƒ¨å’Œå››ä¸ªå˜é•¿éƒ¨åˆ†ç»„æˆï¼š

```text
+---------------------+-----------------------+-----------------------+-----------------------+-----------------------+
| Header (12 bytes)   | Question Section      | Answer Section        | Nameserver Section    | Additional Section    |
+---------------------+-----------------------+-----------------------+-----------------------+-----------------------+
| äº‹åŠ¡ ID ä¸æ ‡å¿—ä½      | æŸ¥è¯¢è¯·æ±‚åˆ—è¡¨           | å›ç­”èµ„æºè®°å½•åˆ—è¡¨       | æˆæƒæœåŠ¡å™¨è®°å½•åˆ—è¡¨     | é™„åŠ èµ„æºè®°å½•åˆ—è¡¨       |
+---------------------+-----------------------+-----------------------+-----------------------+-----------------------+
```

#### 1.1 Header (å¤´éƒ¨)
å›ºå®šé•¿åº¦ä¸º 12 å­—èŠ‚ã€‚åŒ…å« IDã€Flagsã€ä»¥åŠåç»­å„éƒ¨åˆ†çš„è®¡æ•°å™¨ï¼ˆQDCOUNT, ANCOUNT, NSCOUNT, ARCOUNTï¼‰ã€‚

#### 1.2 Resource Record (èµ„æºè®°å½•)
Answer, Nameserver, Additional éƒ¨åˆ†å‡ä½¿ç”¨æ­¤æ ¼å¼ï¼š

- **NAME**: å˜é•¿åŸŸåï¼Œæ”¯æŒ RFC 1035 å‹ç¼©ç®—æ³•ã€‚
- **TYPE (u16)**: è®°å½•ç±»å‹ï¼ˆå¦‚ A=1, SRV=33, E=266 ç­‰ï¼‰ã€‚
- **CLASS (u16)**: åè®®ç±»ã€‚mDNS ä¸­æœ€é«˜ä½ (bit 15) ç”¨äºç¼“å­˜åˆ·æ–°æ ‡å¿—ã€‚
- **TTL (u32)**: ç¼“å­˜ç”Ÿå­˜æ—¶é—´ï¼ˆç§’ï¼‰ã€‚
- **RDLEN (u16)**: èµ„æºæ•°æ® (RDATA) çš„é•¿åº¦ã€‚
- **RDATA**: å…·ä½“çš„èµ„æºå†…å®¹ï¼Œæ ¼å¼ç”± TYPE å†³å®šã€‚

### 2. è‡ªå®šä¹‰ç±»å‹å®šä¹‰ (QType)

| ç±»å‹     | æ•°å€¼ | æè¿°      | RDATA æ ¼å¼                        |
| :------- | :--- | :-------- | :-------------------------------- |
| **A**    | 1    | IPv4 åœ°å€ | 4 å­—èŠ‚ IP                         |
| **AAAA** | 28   | IPv6 åœ°å€ | 16 å­—èŠ‚ IP                        |
| **SRV**  | 33   | æœåŠ¡å®šä½  | Priority + Weight + Port + Target |
| **E**    | 266  | ç«¯ç‚¹åœ°å€  | Flags + Seq + Addr(s) + [Sig]     |

### 3. ç«¯ç‚¹æ‰©å±•ç»†èŠ‚ (Endpoint Extensions)

#### 3.1 RDATA çº¿åè®®æ ¼å¼

##### åŒ…æ ¼å¼

```text
+--------+-----------------+--------------------+----------------------------+
| flags  | sequence(varint)| addr(s)            | signature (optional)       |
+--------+-----------------+--------------------+----------------------------+
| u8     | QUIC varint     | v4: 2+4 / v6: 2+16 | scheme(u16)+len(varint)+N  |
+--------+-----------------+--------------------+----------------------------+
```

##### flags (u8) å­—æ®µå®šä¹‰:
- bit 7 (0x80): MAIN - ä¸»åœ°å€æ ‡å¿—
- bit 6 (0x40): SIGNED - æ˜¯å¦æœ‰ç­¾åæ ‡å¿—  
- bit 5 (0x20): SEQUENCED - æ˜¯å¦æœ‰åºå·
- bit 4 (0x10): FAMILY - 0=IPv4, 1=IPv6
- bit 3 (0x08): FORWARD - 0=ç›´è¿, 1=ä¸­è½¬
- bits 2-0: ä¿ç•™ä½

##### åœ°å€æ ¼å¼:
- ç›´è¿: `port(u16)` + `IP(u32/u128)`
- ä¸­è½¬: `outer_port(u16)` + `outer_IP(u32/u128)` + `agent_port(u16)` + `agent_IP(u32/u128)`
- `sequence`: DNS è®°å½•ç¼–å·ï¼ŒåŒä¸€ç¼–å·çš„è®°å½•è§†ä¸ºä¸€ä¸ªæœºå™¨ï¼Œå¯ä»¥ä½¿ç”¨å¤šè·¯å¾„è¿æ¥
- `signature`: å½“ `SIGNED` ç½®ä½æ—¶ï¼Œå…è®¸é™„åŠ ç­¾åå­—æ®µ

#### 3.2 æ ‡å¿—ä½æ©ç  (Flags Mask)
- `0b1000_0000`: **MAIN** (ä¸»åœ°å€æ ‡å¿—)
- `0b0100_0000`: **SIGNED** (åŒ…å«ç­¾åæ ‡å¿—)
- `0b0010_0000`: **SEQUENCED** (åŒ…å«åºå·æ ‡å¿—)
- `0b0001_0000`: **FAMILY** (åœ°å€æ—: 0=IPv4, 1=IPv6)
- `0b0000_1000`: **FORWARD** (è¿æ¥ç±»å‹: 0=ç›´è¿, 1=ä¸­ç»§)

#### 3.3 åœ°å€æ ¼å¼ (Address Format)
- **ç›´è¿**: `Port(u16)` + `IP(u32/u128)`
- **ä¸­ç»§**: `OuterPort(u16)` + `OuterIP(u32/u128)` + `AgentPort(u16)` + `AgentIP(u32/u128)`

#### 3.4 ç­¾åæ ¼å¼ (Signature)
è‹¥åŒ…å«ç­¾åï¼Œæ ¼å¼ä¸ºï¼š`Scheme (u16)` + `Length (VarInt)` + `Data (N bytes)`ã€‚

---

## ğŸ›  é¡¹ç›®ç»“æ„

- `src/parser/`ï¼šæ ¸å¿ƒåè®®è§£æå®ç°ï¼ˆNom è§£æå™¨ï¼‰ã€‚
- `src/protocol.rs`ï¼šUDP ç»„æ’­ä¸æŠ¥æ–‡è·¯ç”±é€»è¾‘ã€‚
- `src/mdns.rs`ï¼šé«˜å±‚ mDNS å‘ç°ä¸å“åº” APIã€‚
- `examples/`ï¼šåŒ…å«æŸ¥è¯¢ã€å‘ç°ä¸å¹¿æ’­çš„ç¤ºä¾‹ä»£ç ã€‚
